import{Q as ee,a as te}from"./QSpinnerDots-BsIIeB5d.js";import{_ as ae,d,c as N,M as oe,I as le,J as R,e as se,f as y,w as s,u as ne,o as r,b as o,a as V,h as i,t as c,i as I,j as T,l as g,n as ie,p as re,k as _,P as $,R as j,m as ue,E as z,S as de}from"./main-BtbfkAaC.js";import{Q as ce,a as B}from"./QBreadcrumbs-D-UkWGgU.js";import{Q}from"./QItemLabel-eG93G_dM.js";import{f as pe,u as me,_ as ve,a as fe,Q as ye,b as ge,d as E,e as b}from"./NavigationDrawer-DiYLZfbT.js";import{Q as A}from"./QSelect-CG3_3xNS.js";import{Q as _e}from"./QForm-CbK6kz7O.js";import{u as be,c as Ce}from"./conversations-iese4dpW.js";import{u as xe}from"./people-CpNVsY3R.js";import"./position-engine-C8qud-4P.js";const we={key:0,class:"text-center q-pa-xl"},qe={class:"q-mt-md"},he={key:1,class:"text-center q-pa-xl"},Ve={class:"text-h6 text-negative q-mt-md"},Qe={key:2},Le={class:"breadcrumb-nav q-mb-md"},Pe={class:"row justify-center"},ke={class:"col-12 col-md-10 col-lg-8"},Se={key:0,class:"text-caption q-ml-xs"},De={class:"row q-col-gutter-sm"},Fe={class:"col-7 col-sm-6"},Ie={class:"col"},Te={class:"row q-gutter-sm justify-end q-mt-lg"},Be={__name:"ConversationCreateView",setup(Ee){const v=oe(),p=ne(),L=me(),x=be(),m=xe(),w=d(!1),P=d(!1),k=d(!1),S=d(!1),D=d(null),n=d(null),u=N(()=>v.params.id&&v.params.id!=="new"),a=le({participants:[],date:new Date().toISOString().split("T")[0],type:"",location:"",notes:"",private:!1}),q=d([]),h=d([]),C=d([]),M=()=>{a.participants=[],a.date=new Date().toISOString().split("T")[0],a.type="",a.location="",a.notes="",a.private=!1};N(()=>m.getPeopleList);const O=l=>{P.value=l,l&&(S.value=!1,D.value=null)},H=l=>{S.value=!0,D.value=l,P.value=!1},U=async()=>{if(m.getPeopleList.length===0)try{await m.fetchPeople()}catch(l){console.error("Failed to load people:",l)}C.value=[...m.getPeopleList]},F=async()=>{O(!0);try{if(await U(),u.value){const l=v.params.id;await x.fetchConversationById(l),n.value=x.selectedConversation,n.value&&(a.participants=n.value.participants.map(t=>t.id),a.date=n.value.date,a.type=n.value.type,a.location=n.value.location||"",a.notes=n.value.notes||"",a.private=n.value.private||!1)}else v.query.participants&&(a.participants=v.query.participants.split(","))}catch(l){console.error("Failed to load data:",l),H("Failed to load data")}finally{O(!1)}},J=async()=>{k.value=!0;try{const l={participant_ids:a.participants,date:a.date,type:a.type,location:a.location===null?"":a.location||"",notes:a.notes,private:a.private};if(u.value){const t=await x.updateConversation(n.value.id,l);L.notify({type:"positive",message:"Conversation updated successfully",position:"top",timeout:3e3,actions:[{icon:"close",color:"white",dense:!0}]}),p.push({name:"conversation-detail",params:{id:t.id}})}else{const t=await x.createConversation(l);L.notify({type:"positive",message:"Conversation added successfully",position:"top",timeout:6e3,actions:[{icon:"add",color:"white",dense:!0,label:"Add Another",handler:()=>{M(),p.push({name:"conversation-create"})}},{icon:"close",color:"white",dense:!0}]}),p.push({name:"conversation-detail",params:{id:t.id}})}}catch(l){console.error("Failed to save conversation:",l),L.notify({type:"negative",message:`Failed to ${u.value?"update":"create"} conversation. Please try again.`,position:"top",timeout:4e3})}finally{k.value=!1}},W=()=>{u.value&&n.value?p.push({name:"conversation-detail",params:{id:n.value.id}}):p.push({name:"conversations"})},G=()=>{p.push({name:"conversations"})},K=()=>{u.value&&n.value&&p.push({name:"conversation-detail",params:{id:n.value.id}})},X=async()=>{try{const t=await(await fetch("/api/suggestions/conversation-locations/")).json();q.value=t.locations||[],h.value=[...q.value]}catch(l){console.error("Failed to load conversation location suggestions:",l)}},Y=(l,t)=>{t(()=>{if(l==="")h.value=[...q.value];else{const e=l.toLowerCase();h.value=q.value.filter(f=>f.toLowerCase().indexOf(e)>-1)}})},Z=(l,t)=>{t(()=>{if(l==="")C.value=[...m.getPeopleList];else{const e=l.toLowerCase();C.value=m.getPeopleList.filter(f=>f.name.toLowerCase().includes(e)||f.name_ext&&f.name_ext.toLowerCase().includes(e))}})};return R(()=>v.params.id,(l,t)=>{l&&l!==t&&F()}),se(()=>{F(),X()}),R(()=>m.getPeopleList,l=>{C.value=[...l]},{immediate:!0}),(l,t)=>(r(),y(pe,{view:"lHh Lpr lFf"},{default:s(()=>[o(ve,{onToggleDrawer:t[0]||(t[0]=e=>w.value=!w.value)}),o(fe,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=e=>w.value=e)},null,8,["modelValue"]),o(ye,null,{default:s(()=>[o(ge,{class:"q-pa-md",style:{"background-color":"#f8f9fa"}},{default:s(()=>[P.value?(r(),V("div",we,[o(ee,{size:"50px",color:"primary"}),i("div",qe,c(u.value?"Loading conversation details...":"Loading..."),1)])):S.value?(r(),V("div",he,[o(I,{name:"error_outline",size:"80px",color:"negative"}),i("div",Ve,c(D.value),1),o(T,{color:"primary",label:"Try Again",class:"q-mt-md",onClick:F})])):(r(),V("div",Qe,[i("div",Le,[o(ce,{class:"text-grey-6"},{default:s(()=>[o(B,{icon:"chat",label:"Conversations",onClick:G,class:"cursor-pointer"}),u.value?(r(),y(B,{key:0,label:n.value?.participants?.map(e=>e.name).join(", ")||"Conversation",onClick:K,class:"cursor-pointer"},null,8,["label"])):g("",!0),o(B,{label:u.value?"Edit":"Add Conversation"},null,8,["label"])]),_:1})]),i("div",Pe,[i("div",ke,[o(_e,{onSubmit:J,class:"q-gutter-md",autocomplete:"off"},{default:s(()=>[o(ie,null,{default:s(()=>[o(re,null,{default:s(()=>[t[9]||(t[9]=i("div",{class:"text-h6 q-mb-md"},"Conversation Details",-1)),o(A,{modelValue:a.participants,"onUpdate:modelValue":t[2]||(t[2]=e=>a.participants=e),options:C.value,label:"Participants *",filled:"",multiple:"","option-value":"id","emit-value":"","map-options":"","use-chips":"","stack-label":"","use-input":"","input-debounce":"0",autocomplete:"off",rules:[e=>e&&e.length>0||"At least one participant is required"],onPopupShow:U,onFilter:Z},{option:s(e=>[o(E,$(j(e.itemProps)),{default:s(()=>[o(b,null,{default:s(()=>[o(Q,null,{default:s(()=>[_(c(e.opt.name),1)]),_:2},1024),e.opt.name_ext?(r(),y(Q,{key:0,caption:""},{default:s(()=>[_(c(e.opt.name_ext),1)]),_:2},1024)):g("",!0)]),_:2},1024)]),_:2},1040)]),"selected-item":s(e=>[o(te,{removable:"",onRemove:f=>e.removeAtIndex(e.index),tabindex:e.tabindex,class:"q-ma-xs"},{default:s(()=>[_(c(e.opt.name)+" ",1),e.opt.name_ext?(r(),V("span",Se,"("+c(e.opt.name_ext)+")",1)):g("",!0)]),_:2},1032,["onRemove","tabindex"])]),_:1},8,["modelValue","options","rules"]),i("div",De,[i("div",Fe,[o(A,{modelValue:a.type,"onUpdate:modelValue":t[3]||(t[3]=e=>a.type=e),options:ue(Ce),label:"Conversation Type *",filled:"",required:"","option-value":"value","option-label":"label","emit-value":"","map-options":"",autocomplete:"off",rules:[e=>!!e||"Conversation type is required"]},{"selected-item":s(e=>[e.opt.icon?(r(),y(b,{key:0,avatar:""},{default:s(()=>[o(I,{name:e.opt.icon},null,8,["name"])]),_:2},1024)):g("",!0),o(b,null,{default:s(()=>[o(Q,null,{default:s(()=>[_(c(e.opt.label),1)]),_:2},1024)]),_:2},1024)]),option:s(e=>[o(E,$(j(e.itemProps)),{default:s(()=>[e.opt.icon?(r(),y(b,{key:0,avatar:""},{default:s(()=>[o(I,{name:e.opt.icon},null,8,["name"])]),_:2},1024)):g("",!0),o(b,null,{default:s(()=>[o(Q,null,{default:s(()=>[_(c(e.opt.label),1)]),_:2},1024)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","options","rules"])]),i("div",Ie,[o(z,{modelValue:a.date,"onUpdate:modelValue":t[4]||(t[4]=e=>a.date=e),label:"Date *",type:"date",filled:"",required:"",autocomplete:"off",rules:[e=>!!e||"Date is required"]},null,8,["modelValue","rules"])])]),a.type==="in_person"?(r(),y(A,{key:0,modelValue:a.location,"onUpdate:modelValue":t[5]||(t[5]=e=>a.location=e),label:"Location",hint:"Where did this conversation take place?",filled:"","use-input":"",clearable:"","input-debounce":"0","new-value-mode":"add-unique",options:h.value,onFilter:Y,class:"q-mb-xs"},{"no-option":s(()=>[o(E,null,{default:s(()=>[o(b,{class:"text-grey"},{default:s(()=>[...t[8]||(t[8]=[_(" Type to add new location ",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue","options"])):g("",!0),t[10]||(t[10]=i("div",{class:"text-h6 q-mt-md q-mb-sm"},"Notes",-1)),o(z,{modelValue:a.notes,"onUpdate:modelValue":t[6]||(t[6]=e=>a.notes=e),label:"Conversation notes *",type:"textarea",rows:"6",filled:"",required:"",autocomplete:"off",rules:[e=>!!e||"Notes are required"]},null,8,["modelValue","rules"]),o(de,{modelValue:a.private,"onUpdate:modelValue":t[7]||(t[7]=e=>a.private=e),label:"Private conversation",color:"orange"},null,8,["modelValue"]),t[11]||(t[11]=i("div",{class:"text-caption text-grey-6 q-ml-lg"}," Private conversations are only visible to you ",-1))]),_:1})]),_:1}),i("div",Te,[o(T,{flat:"",label:"Cancel",color:"grey-7",onClick:W}),o(T,{type:"submit",label:u.value?"Save Changes":"Add Conversation",color:"primary",loading:k.value},null,8,["label","loading"])])]),_:1})])])]))]),_:1})]),_:1})]),_:1}))}},Je=ae(Be,[["__scopeId","data-v-55e21b87"]]);export{Je as default};
